from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole

# Создаем модель общения
giga = GigaChat(
   # смотри в чатике
   credentials="YjJlYzktZjJmYy03M2E3LTgzYTItZmVmMzI3ZDM4YzYxOjg4YjcxYjZiLTY5YmYtNDM0ZS1iODkwLThmN2RkNTdjMjI1Z",
   scope="GIGACHAT_API_PERS",
   model="GigaChat-2"
   ,verify_ssl_certs=False
)

# Задаем контекст общения (например селект из базы с нужными отрывками)
context = ""

# context = """
# Жили-были дед да баба, и была у них курочка Ряба. Не простая курочка, а волшебная! Каждое утро она снесла яички не простые, а золотые. Дед с бабой радовались и продавали их на рынке, зарабатывая много денег.
# Однажды курочка Ряба перестала нести золотые яйца. Загрустили дед с бабой, но Ряба их успокоила: «Не печальтесь, я вам лучше сказку расскажу!»
# И рассказала курочка удивительную историю о том, как в далёкой стране жила принцесса, которая любила приключения. Она отправилась в лес, где встретила лесных жителей, которые помогли ей найти волшебный клад.
# Дед с бабой так увлеклись рассказом, что забыли о своих бедах. А курочка Ряба снова начала нести золотые яйца, да такие красивые, что все вокруг любовались ими и радовались.
# С тех пор дед, баба и курочка Ряба жили счастливо, а сказка о приключениях принцессы передавалась из уст в уста, даря всем радость и вдохновение.
# """

# Храним историю переписки для диалогового общения
# Предзаписываем промт на максимальное соответствие контексту и контекст общения
history = [
    Messages(role=MessagesRole.SYSTEM, content="Отвечай строго по данному контексту. Отвечай максимально кратко. В конце ответа приведи цитату из контекста, строго отвечающую на вопрос, если такая есть."),
    Messages(role=MessagesRole.USER, content=context)
]

def chat_with_giga(context=context, history=history):
    while True:
        # Передаем вопрос
        user_input = input("Вопрос: ")
        if user_input == 'Закончить беседу':
            break
            
        # Добавляем новый вопрос в историю
        history.append(Messages(role=MessagesRole.USER, content=user_input))
        
        # Создаем объект чата с историей сообщений и гиперпараметрами
        chat_object = Chat(
            messages=history,
            max_tokens=100,               # Максимальная цена запроса (походу не работает, тратит больше)
            temperature=0.0,              # Максимальная строгость, без творчества
            top_p=0.1,                    # Только самые распространенные ответы
            presence_penalty=2.0,         # Гарантирует использование только имеющихся фактов, без фантазии
            frequency_penalty=0.5         # Небольшой штраф за повторение
        )
        
        # Генерируем ответ
        response = giga.chat(chat_object)
        
        # Сохраняем ответ в историю
        assistant_reply = response.choices[0].message.content
        history.append(Messages(role=MessagesRole.ASSISTANT, content=assistant_reply))
        
        # Выводим ответ
        print(f"Ответ: {assistant_reply} \nЧтобы завершить общение, напишите: Закончить беседу")

# Запускаем беседу
chat_with_giga()